import subprocess
from brain.scene_to_text import make_human_readable

MODEL = "mistral:7b"

SYSTEM = """
–¢—ã ‚Äî –º–æ–¥—É–ª—å –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è.
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ: 1‚Äì3 —Å–ª–æ–≤–∞.
–ü–∏—à–∏ —Å—Ä–∞–∑—É —Å —Å—É—Ç–∏, –±–µ–∑ –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑.
–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- ¬´—á–µ–ª–æ–≤–µ–∫¬ª
- ¬´–ª–∏—Ü–æ –ú–∞—Ç–≤–µ—è¬ª
- ¬´—á–µ–ª–æ–≤–µ–∫ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º¬ª
- ¬´–Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ¬ª

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –¥–ª–∏–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
- –∑–∞–≥–∞–¥–∫–∏, –ø—Ä–∏–º–µ—Ä—ã, –∑–∞–¥–∞—á–∏
- –æ—Ç–≤–µ—Ç—ã –Ω–µ –ø–æ —Ç–µ–º–µ –∫–∞–º–µ—Ä—ã

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –æ—Ç–≤–µ—á–∞–π ¬´–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ¬ª.
–¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ-—Ä—É—Å—Å–∫–∏.
–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–π –µ–≥–æ.
"""


def ask_llm(prompt: str):
    process = subprocess.Popen(
        ["ollama", "run", MODEL],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        encoding="utf-8",    # üî• –ö–õ–Æ–ß–ï–í–û–ï
        errors="ignore"      # üî• –Ω–∞ —Å–ª—É—á–∞–π –≥–ª—é–∫–æ–≤
    )
    out, err = process.communicate(prompt)
    return out.strip()


def describe_scene(objects, faces) -> str:
    # –¥–µ–ª–∞–µ–º –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –¥–µ—Ç–µ–∫—Ü–∏–π
    scene_text = make_human_readable(objects, faces)
    print("[LLM] scene_text:", scene_text)

    prompt = f"""
{SYSTEM}

–í–æ—Ç —á—Ç–æ –≤–∏–¥–∏—Ç –∫–∞–º–µ—Ä–∞:
{scene_text}

–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ (1‚Äì3 —Å–ª–æ–≤–∞).
"""

    print("[LLM] –û—Ç–ø—Ä–∞–≤–ª—è—é prompt –≤ ollama...")
    raw = ask_llm(prompt)
    print("[LLM] RAW:", raw)

    # –ñ–Å–°–¢–ö–ê–Ø –æ–±—Ä–µ–∑–∫–∞ –æ—Ç–≤–µ—Ç–∞ –¥–æ 3 —Å–ª–æ–≤, –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    short = " ".join(raw.split()[:3]).strip()

    # –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ–≥–æ –Ω–µ –ø—Ä–∏—à–ª–æ
    if not short:
        short = "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ"

    return short